var VirtualGrid=L.Layer.extend({options:{cellSize:100,previousCellSize:0,updateInterval:150,pixelSizeX:0,pixelSizeY:0,zoomTriger:0},rects:{},rectList:{},currentColumns:{},currentRows:{},cellDetails:{},initialize:function(e){this.cellDetails={},e=L.setOptions(this,e),this.on("cellsupdated",this._cellsupdated),this.on("cellcreate",this._cellcreate),this.on("cellenter",this._cellenter),this.on("cellleave",this._cellleave),this._zooming=!1,e.previousCellSize=e.cellSize},onAdd:function(e){this._map=e,this._update=L.Util.throttle(this._update,this.options.updateInterval,this),this._reset(),this._update()},onRemove:function(){this._map.removeEventListener(this.getEvents(),this),this._removeCells()},getEvents:function(){return{moveend:this._update,zoomstart:this._zoomstart,zoomend:this._reset}},addTo:function(e){return e.addLayer(this),this},removeFrom:function(e){return e.removeLayer(this),this},_zoomstart:function(){this._zooming=!0},_reset:function(){this._removeCells(),this._cells={},this._activeCells={},this._cellsToLoad=0,this._cellsTotal=0,this._cellNumBounds=this._getCellNumBounds(),this._resetWrap(),this._zooming=!1},_resetWrap:function(){var e=this._map,t=e.options.crs;if(!t.infinite){var o=this._getCellSize();t.wrapLng&&(this._wrapLng=[Math.floor(e.project([0,t.wrapLng[0]]).x/o),Math.ceil(e.project([0,t.wrapLng[1]]).x/o)]),t.wrapLat&&(this._wrapLat=[Math.floor(e.project([t.wrapLat[0],0]).y/o),Math.ceil(e.project([t.wrapLat[1],0]).y/o)])}},_getCellSize:function(){return this.options.cellSize},_update:function(){if(this._map){var e=this._map.getBounds(),t=parseFloat(e._northEast.lat.toFixed(5));if(t=(t+.001).toFixed(5),t=normaliseLatLngUp(t),e._northEast.lat=t,e._northEast.lng=normaliseLatLngUp(parseFloat(e._northEast.lng.toFixed(5))+.001).toFixed(5),(t=parseFloat(e._southWest.lat.toFixed(5)))<0?(t=(t+.001).toFixed(5),t=normaliseLatLngDown(t),e._southWest.lat=t):(t=(t-.001).toFixed(5),t=normaliseLatLngDown(t),e._southWest.lat=t),e._southWest.lng=normaliseLatLngUp(parseFloat(e._southWest.lng.toFixed(5))-.001).toFixed(5),17==this._map.getZoom()||18==this._map.getZoom())mymap.latLngToContainerPoint(e.getNorthWest());e=this._map.getBounds();var o=L.bounds(this._map.project(e.getNorthWest()),this._map.project(e.getSouthEast())),i=this._getCellSize(),s=L.bounds(o.min.divideBy(i).floor(),o.max.divideBy(i).floor());this._removeOtherCells(s),this._addCells(s),this.fire("cellsupdated")}},_addCells:function(e){var t,o,i,s=[],r=e.getCenter(),n=this._map.getZoom();for(t=e.min.y;t<=e.max.y;t++)for(o=e.min.x;o<=e.max.x;o++)(i=L.point(o,t)).z=n,this._isValidCell(i)&&s.push(i);var a=s.length;if(0!==a)for(this._cellsToLoad+=a,this._cellsTotal+=a,s.sort(function(e,t){return e.distanceTo(r)-t.distanceTo(r)}),o=0;o<a;o++)this._addCell(s[o])},_isValidCell:function(e){var t=this._map.options.crs;if(!t.infinite){var o=this._cellNumBounds;if(!t.wrapLng&&(e.x<o.min.x||e.x>o.max.x)||!t.wrapLat&&(e.y<o.min.y||e.y>o.max.y))return!1}if(!this.options.bounds)return!0;var i=this._cellCoordsToBounds(e);return L.latLngBounds(this.options.bounds).intersects(i)},_cellCoordsToBounds:function(e){var t=this._map,o=this.options.cellSize,i=e.multiplyBy(o),s=i.add([o,o]),r=t.wrapLatLng(t.unproject(i,e.z)),n=t.wrapLatLng(t.unproject(s,e.z));return L.latLngBounds(r,n)},_cellCoordsToKey:function(e){return e.x+":"+e.y},_keyToCellCoords:function(e){var t=e.split(":"),o=parseInt(t[0],10),i=parseInt(t[1],10);return L.point(o,i)},_removeOtherCells:function(e){for(var t in this._cells)e.contains(this._keyToCellCoords(t))||this._removeCell(t)},_removeCell:function(e){var t=this._activeCells[e];if(t){var o=hardFixed(t.bounds.getCenter().lat,4)+":"+hardFixed(t.bounds.getCenter().lng,4);delete this._activeCells[e],this.cellLeave&&this.cellLeave(t.bounds,t.coords),this.fire("cellleave",{bounds:t.bounds,coords:t.coords}),delete this.cellDetails[o]}},_removeCells:function(){for(var e in this._cells){var t=this._cells[e].bounds,o=this._cells[e].coords;this.cellLeave&&this.cellLeave(t,o),this.fire("cellleave",{bounds:t,coords:o})}},_addCell:function(e){this._wrapCoords(e);var t=this._cellCoordsToKey(e),o=this._cells[t];o&&!this._activeCells[t]&&(this.cellEnter&&this.cellEnter(o.bounds,e),this.fire("cellenter",{bounds:o.bounds,coords:e}),this._activeCells[t]=o),o||(o={coords:e,bounds:this._cellCoordsToBounds(e)},this._cells[t]=o,this._activeCells[t]=o,this.createCell&&this.createCell(o.bounds,e),this.fire("cellcreate",{bounds:o.bounds,coords:e}))},_wrapCoords:function(e){e.x=this._wrapLng?L.Util.wrapNum(e.x,this._wrapLng):e.x,e.y=this._wrapLat?L.Util.wrapNum(e.y,this._wrapLat):e.y},_getCellNumBounds:function(){var e=this._map.getPixelWorldBounds(),t=this._getCellSize();return e?L.bounds(e.min.divideBy(t).floor(),e.max.divideBy(t).ceil().subtract([1,1])):null},_cellleave:function(e){try{var t=this.rects[coordsToKey(e.coords)];mymap.removeLayer(t)}catch(e){}var o=e.bounds.getCenter();mymap.project(o)},_cellenter:function(e){if(mymap.getZoom()==this.options.zoomTriger){var t=this.rects[coordsToKey(e.coords)];t&&mymap.addLayer(t)}},_cellcreate:function(e){if(this._map.getZoom()==this.options.zoomTriger){var t=coordsToKey(e.coords),o=e.bounds.getCenter(),i=this._map.project(o);this._map.getPixelBounds().contains(i)&&(this.currentColumns[hardFixed(o.lng,4)]==hardFixed(o.lng,4)||(this.currentColumns[hardFixed(o.lng,4)]=hardFixed(o.lng,4)),this.currentRows[hardFixed(o.lat,4)]==hardFixed(o.lat,4)||(this.currentRows[hardFixed(o.lat,4)]=hardFixed(o.lat,4))),this.cellDetails[hardFixed(o.lat,4)+":"+hardFixed(o.lng,4)]=={key:t,centerPoint:o,bounds:e.bounds}||(this.cellDetails[hardFixed(o.lat,4)+":"+hardFixed(o.lng,4)]={key:t,centerPoint:o,bounds:e.bounds});var s,r=!1;for(key in rectsToBuy)if(e.bounds.contains(rectsToBuy[key])){r=!0,s=key;break}if(r){this.rects[coordsToKey(e.coords)]=L.rectangle(e.bounds,{color:"#999",weight:1,opacity:.4,fillOpacity:0}).addTo(this._map);var n=e.bounds.getCenter(),a=L.rectangle(e.bounds,{color:"#990000",weight:2,fillOpacity:.5});a.addTo(this._map),a.on("click",function(e){"REMOVESINGLE"==actionMode&&(this.removeFrom(this._map),delete rectsToBuy[s],updateNewCard())}),lightGrids[this._map.getZoom()].rectList[hardFixed(n.lat,5)+":"+hardFixed(n.lng,5)]=a}else this.options.hideGrid||(this.rects[coordsToKey(e.coords)]=L.rectangle(e.bounds,{color:"#999",weight:1,opacity:.4,fillOpacity:0}).addTo(this._map));this.options.hideGrid||(this.rects[coordsToKey(e.coords)].on("click",function(e){if(e.sourceTarget.token_id)tokenInfo(e.sourceTarget.token_id);else{var t=e.sourceTarget._bounds.getCenter();if("BUYMULTI"==actionMode)if(onDownEvent)onDownEvent=!1,$("#buyMultiple").removeClass("hollow"),actionMode="";else{if(!checkBuyPointAllowed(t,!0))return;if(Object.keys(rectsToBuy).length>=45)return showError("You can only add a maximum of 45 plots to one card.<br/><br/>Please complete this purchase and start a new card to continue.","Planet Crypto"),onDownEvent=!1,$("#buyMultiple").removeClass("hollow"),void(actionMode="");onDownEvent=!0,rectsToBuy[hardFixed(t.lat,5)+":"+hardFixed(t.lng,5)]=t,updateNewCard(),(o=L.rectangle(e.sourceTarget._bounds,{color:"#990000",weight:2,fillOpacity:.5})).addTo(this._map),o.on("click",function(e){"REMOVESINGLE"==actionMode&&(this.removeFrom(this._map),delete rectsToBuy[hardFixed(t.lat,5)+":"+hardFixed(t.lng,5)],updateNewCard()),"BUYMULTI"==actionMode&&(onDownEvent=!1,$("#buyMultiple").removeClass("hollow"),actionMode="")}),lightGrids[this._map.getZoom()].rectList[hardFixed(t.lat,5)+":"+hardFixed(t.lng,5)]=o}if("BUYSINGLE"==actionMode){if(!checkBuyPointAllowed(t,!0))return;if(Object.keys(rectsToBuy).length>=45)return showError("You can only add a maximum of 45 plots to one card.<br/><br/>Please complete this purchase and start a new card to continue.","Planet Crypto"),onDownEvent=!1,$("#buySingle").removeClass("hollow"),void(actionMode="");var o;rectsToBuy[hardFixed(t.lat,5)+":"+hardFixed(t.lng,5)]=t,updateNewCard(),(o=L.rectangle(e.sourceTarget._bounds,{color:"#990000",weight:2,fillOpacity:.5})).addTo(this._map),o.on("click",function(e){"REMOVESINGLE"==actionMode&&(this.removeFrom(this._map),delete rectsToBuy[hardFixed(t.lat,5)+":"+hardFixed(t.lng,5)],updateNewCard())}),lightGrids[this._map.getZoom()].rectList[hardFixed(t.lat,5)+":"+hardFixed(t.lng,5)]=o}}}),this.rects[coordsToKey(e.coords)].on("mouseover",function(e){if("0.6"==e.sourceTarget.options.fillOpacity);else if(onDownEvent&&"BUYMULTI"==actionMode){if(!checkBuyPointAllowed(e.sourceTarget._bounds.getCenter(),!1))return;if(Object.keys(rectsToBuy).length>=45)return showError("You can only add a maximum of 45 plots to one card.<br/><br/>Please complete this purchase and start a new card to continue.","Planet Crypto"),onDownEvent=!1,$("#buyMultiple").removeClass("hollow"),void(actionMode="");if("0.4"==e.sourceTarget.options.fillOpacity);else{rectsToBuy[hardFixed(e.sourceTarget._bounds.getCenter().lat,5)+":"+hardFixed(e.sourceTarget._bounds.getCenter().lng,5)]=e.sourceTarget._bounds.getCenter(),updateNewCard();var t=L.rectangle(e.sourceTarget._bounds,{color:"#990000",weight:2,fillOpacity:.5});t.addTo(this._map),t.on("click",function(e){"REMOVESINGLE"==actionMode&&(this.removeFrom(this._map),delete rectsToBuy[hardFixed(e.sourceTarget._bounds.getCenter().lat,5)+":"+hardFixed(e.sourceTarget._bounds.getCenter().lng,5)],updateNewCard()),"BUYMULTI"==actionMode&&(onDownEvent=!1,$("#buyMultiple").removeClass("hollow").addClass("success"),actionMode="")}),lightGrids[this._map.getZoom()].rectList[hardFixed(e.sourceTarget._bounds.getCenter().lat,5)+":"+hardFixed(e.sourceTarget._bounds.getCenter().lng,5)]=t}}}),this.rects[coordsToKey(e.coords)].on("mouseout",function(e){e.sourceTarget.options.fillOpacity}))}},_cellsupdated:function(e){for(key in this.currentColumns={},this.currentRows={},this.cellDetails){var t=this.cellDetails[key].centerPoint,o=this._map.project(t);this._map.getPixelBounds().contains(o)&&(this.currentColumns[hardFixed(t.lng,4)]==hardFixed(t.lng,4)||(this.currentColumns[hardFixed(t.lng,4)]=hardFixed(t.lng,4)),this.currentRows[hardFixed(t.lat,4)]==hardFixed(t.lat,4)||(this.currentRows[hardFixed(t.lat,4)]=hardFixed(t.lat,4)))}}});