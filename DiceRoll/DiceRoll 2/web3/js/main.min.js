function startApp(){cryptodiceContract=new web3.eth.Contract(cryptodiceABI,contractAddress),isMainGame&&(showNetwork(),showCoinbase(),showGetBalance(),setupStats(),getAllPlayerBets(),cryptodiceContract.methods.maxMultiRolls().call(function(e,t){if(!e){let e=document.getElementById("number_of_rolls");for(let r=0;r<t;r++){let t=document.createElement("option");t.text=r+1,t.value=r+1,t.onselect="updatePotentialProfit();",e.appendChild(t)}}})),getLatestGames()}function resetRollDicebg(){rolling=!1,updateInnerHTML("RollDiceButton","ROLL DICE"),document.getElementById("RollDiceButton").style.backgroundColor="#c74216"}function rollDice(){if(!rolling){if(canPlay){var e=document.getElementById("number_of_rolls").selectedIndex+1;if(e<1&&(e=1),e>1){let t=document.getElementById("stake").value;if((t=new BigNumber(t).times(e)).isGreaterThan(new BigNumber(maxBet))){let t="Your current stake of <b>"+document.getElementById("stake").value;return t+=" * "+e+" Multi Rolls</b> would take you above the current max bet.<br/><br/>",t+="Would you like to reduce your bet to <b>"+e+"Multi Rolls</b> of <b>"+maxBet/e+" Ether </b>?",void alertify.confirm("Crypto Dice",t,function(){document.getElementById("stake").value=maxBet/e,updatePotentialProfit(),rollDice()},function(){console.log("cancel")})}}var t=document.getElementById("RollDiceButton");return updateInnerHTML("RollDiceButton","ROLLING... PLEASE WAIT..."),t.style.backgroundColor="#aaa",rolling=!0,""==(t=document.getElementById("stake")).value||t.value<minBet?(alertify.alert("Crypto Dice","Please enter your stake before playing<br/><br/>It must be a stake of at least: "+minBet+" Ether"),void resetRollDicebg()):t.value>maxBet?(alertify.alert("Crypto Dice","Unfortunately your bet is over the current max bet size of: "+maxBet+" Ether<br/><br/>Please reduce your stake and try again."),void resetRollDicebg()):void(e>1?cryptodiceContract.methods.rollDice(rollUnder,e).estimateGas({from:account,value:web3.utils.toWei(t.value,"ether")},function(r,a){cryptodiceContract.methods.rollDice(rollUnder,e).send({from:account,gas:a,gasPrice:useGasPrice,value:web3.utils.toWei(t.value,"ether")}).on("error",function(e){resetRollDicebg(),alert(e)}).then(function(e){try{var t="<b>Dice Multi Rolls submitted!</b><br/><br/>";t+='Etherscan link: <br/><span class="small"><a href="https://etherscan.io/tx/'+e.transactionHash+'" target="_new">',t+=e.transactionHash+"</a></span><br/>",t+="Gas Used: "+e.gasUsed+"<br/>",t+="<br/>Click OK to continue playing - you can add more Dice Rolls whilst you wait for the result to be mined onto the blockchain, this result will be along shortly - good luck!",resetRollDicebg(),addNewBet(),alertify.alert("Crypto Dice",t)}catch(t){resetRollDicebg(),console.log(JSON.stringify(e.events)),console.log(JSON.stringify(t)),alertify.alert("Crypto Dice","There was an error submitting your Dice Roll - this may of been an issue with your browser or crypto-wallet.<br/><br/>Please try again.")}})}):cryptodiceContract.methods.rollDice(rollUnder).estimateGas({from:account,value:web3.utils.toWei(t.value,"ether")},function(e,r){cryptodiceContract.methods.rollDice(rollUnder).send({from:account,gas:r,gasPrice:useGasPrice,value:web3.utils.toWei(t.value,"ether")}).on("error",function(e){resetRollDicebg(),alert(e)}).then(function(e){try{var t="<b>Dice Roll submitted!</b><br/><br/>";t+='Etherscan link: <br/><span class="small"><a href="https://etherscan.io/tx/'+e.transactionHash+'" target="_new">',t+=e.transactionHash+"</a></span><br/>",t+="Gas Used: "+e.gasUsed+"<br/>",t+='Bet ID:<br/><span class="small">'+e.events.DiceRollResult.returnValues.betID+"</span><br/>",t+="<br/>Click OK to continue playing - you can add more Dice Rolls whilst you wait for the result to be mined onto the blockchain, this result will be along shortly - good luck!",resetRollDicebg(),addNewBet(e.events.DiceRollResult.returnValues.betID),alertify.alert("Crypto Dice",t)}catch(t){resetRollDicebg(),console.log(JSON.stringify(e.events)),console.log(JSON.stringify(t)),alertify.alert("Crypto Dice","There was an error submitting your Dice Roll - this may of been an issue with your browser or crypto-wallet.<br/><br/>Please try again.")}})}))}showNotConnectedMsg()}}function selectRollUnder(e){return rollUnder=e.text,resetRollUnderColors(),e.style.color="#f9531c",updatePotentialProfit(),!1}function updatePotentialProfit(){var e=document.getElementById("number_of_rolls").selectedIndex+1;e<1&&(e=1),console.log(e);var t=document.getElementById("stake").value;(isNaN(t)||""==t)&&(t=0),t=new BigNumber(t);var r=new BigNumber(t);o=(o=t.times(getBetDivisor(rollUnder)).dividedBy(100)).minus(r);var a=new BigNumber(o.dividedBy(100)),l=new BigNumber(a.times(houseEdge)),o=(new BigNumber(a.times(100-houseEdge)),l.plus(t).times(e));current_potential_profit=o,updateInnerHTML("potentialProfit",o.toFixed(6)+" ether");var n=rollUnder-1;updateInnerHTML("chanceOfWin",n<0?"&nbsp;"+n+"%":n+"%")}function getBetDivisor(e){return 5==e?2e3:10==e?1e3:20==e?500:30==e?330:40==e?250:50==e?200:60==e?166:70==e?142:80==e?125:90==e?1.11*100:100/e*10}function resetRollUnderColors(){resetColor(document.getElementById("rollUnder20")),resetColor(document.getElementById("rollUnder30")),resetColor(document.getElementById("rollUnder40")),resetColor(document.getElementById("rollUnder50")),resetColor(document.getElementById("rollUnder60"))}function resetColor(e){e.style.color="#555"}function showNotConnectedMsg(){var e=!!navigator.platform&&/iPad|iPhone|iPod/.test(navigator.platform),t=!1;navigator.userAgent.toLowerCase().indexOf("android")>-1&&(t=!0),e?alertify.alert("Crypto Dice",'It looks like your not connected to the Mainnet or logged into your Wallet at the moment.<br/><br/>For iOS we recommend: <a href="https://itunes.apple.com/us/app/cipher-browser-ethereum/id1294572970?mt=8">Cipher Ethereum Browser</a> - please connect to the Mainnet when using.'):t?alertify.alert("Crypto Dice",'It looks like your not connected to the Mainnet or logged into your Wallet at the moment.<br/><br/>For Android we recommend: <a href="https://play.google.com/store/apps/details?id=com.cipherbrowser.cipher&hl=en_GB">Cipher Ethereum Browser</a> - please connect to the Mainnet when using.'):alertify.alert("Crypto Dice",'It looks like your not connected to the Mainnet or logged into your Wallet at the moment.<br/><br/>Please connect to <a href="https://metamask.io/" target="_new">Metamask</a> and select the Mainnet to continue')}function showNetwork(){web3.eth.net.getNetworkType((e,t)=>{var r="";"main"==(r=e?"Error:"+e:t>1e12?"testrpc":t)||showNotConnectedMsg(),updateInnerHTML("networkName",r)})}function showCoinbase(){web3.eth.getCoinbase((e,t)=>{var r="";e?r="Error":(r=t,account=r,updateInnerHTML("accountAddr",r))})}function showGetBalance(){web3.eth.getCoinbase((e,t)=>{var r="";e?r="Error1":(r=t,web3.eth.getBalance(r,(e,t)=>{e?r="Error2":updateInnerHTML("accountBalance",r=web3.utils.fromWei(t,"ether")+" Ether")}))})}function setupStats(e){cryptodiceContract.methods.private_getGameState().call(function(t,r){if(!t){var a=new BigNumber(web3.utils.fromWei(r._liveMaxBet,"ether")),l=new BigNumber(web3.utils.fromWei(r._minBet,"ether"));updateInnerHTML("maxBet",a.toNumber().toFixed(4)+" Ether"),updateInnerHTML("minBet",l.toNumber().toFixed(4)+" Ether"),minBet=web3.utils.fromWei(r._minBet,"ether"),e||(document.getElementById("stake").value=minBet),maxBet=web3.utils.fromWei(r._liveMaxBet,"ether"),document.getElementById("minBet").value=minBet,document.getElementById("maxBet").value=maxBet,houseEdge=r._houseEdge,updateInnerHTML("houseEdge",100-houseEdge),updateInnerHTML("minBet2",minBet),canPlay=!0,updatePotentialProfit(),setTimeout(function(){setupStats(!0)},refreshGameStats)}})}function showBet(e){cryptodiceContract.getPastEvents("DiceRollResult",{filter:{betID:e},fromBlock:0,toBlock:"latest"},function(t,r){let a=r[0].transactionHash,l=r[0].returnValues;if(r.length>1)for(let e=1;e<r.length;e++)r[e].returnValues.timestamp>l.timestamp&&(l=r[e].returnValues,a=r[e].transactionHash);let o=new BigNumber(l.stake.toString()),n=new BigNumber(l.profit.toString()),s="";s+='Bet ID:<br/><span class="small2">'+e+"</span>",s+='<table class="u-full-width" ><tbody>',s+="<tr><td></td><td></td></tr>",s+="<tr><td>Player</td><td>"+l.playerAddress+"</td></tr>",s+="<tr><td>Time</td><td>"+formatTSLong(l.timestamp)+"</td></tr>",s+="<tr><td>Roll Under</td><td>"+l.rollUnder+"</td></tr>",s+='<tr><td>TX</td><td class="small"><a href="https://etherscan.io/tx/'+a+'" target="_new">'+a+"</td></tr>",1==l.win?(s+="<tr><td>Result</td><td>"+l.result+"</td></tr>",s+="<tr><td>Stake</td><td>"+web3.utils.fromWei(o.toString()).toString(10)+" Ether</td></tr>",s+='<tr><td>Win?</td><td class="redColor">WIN!</td></tr>',s+="<tr><td>Profit</td><td>+"+web3.utils.fromWei(o.plus(n).toString()).toString(10)+"</td></tr>"):2==l.win?(s+="<tr><td>Result</td><td>Roll Pending</td></tr>",s+="<tr><td>Stake</td><td>"+web3.utils.fromWei(o.toString()).toString(10)+" Ether</td></tr>",s+="<tr><td>Win?</td><td>--</td></tr>",s+="<tr><td>Profit</td><td>--</td></tr>",s+='<tr><td colspan="2" class="small2">This game is still being mined by the blockchain.  We will have your results soon - you can continue to roll more dice whilst you wait!</td></tr>'):0==l.win&&0==l.result?(s+="<tr><td>Result</td><td>Roll Failed</td></tr>",s+="<tr><td>Stake</td><td>"+web3.utils.fromWei(o.toString()).toString(10)+" Ether</td></tr>",s+="<tr><td>Win?</td><td>--</td></tr>",s+="<tr><td>Profit</td><td>Refunded</td></tr>",s+='<tr><td colspan="2" class="small">Very occasionally, the blockchain data oracle service can fail to return a result.  This can be due to the random.org service timing out or the blockchain mining system timing out for example.  In these cases your bet has failed and we refund your stake in full.</td></tr>'):(s+="<tr><td>Result</td><td>"+l.result+"</td></tr>",s+="<tr><td>Stake</td><td>"+web3.utils.fromWei(o.toString()).toString(10)+" Ether</td></tr>",s+="<tr><td>Win?</td><td>LOSE</td></tr>",s+="<tr><td>Loss</td><td>-"+web3.utils.fromWei(o.toString()).toString(10)+"</td></tr>"),s+="</table>",l.win<2&&l.result>0&&(s+="<b>Data Proof</b><br/>",s+='<span class="small">Please read the <a href="dataproofs.htm" target="_new">PROOFS</a> page for a full guide on how we ',s+="allow you to validate your games, but the TL;DR; of it is that for every random result returned there is ",s+='also a data proof generated by a third party Data Oracle service (<a href="https://dAppBridge.com" target="new">dAppBridge</a>).',s+="<br/><br/>",s+="This Data Proof file contains a Keccak256 hash of the original result to prove that it hasnt been altered - and the game is fair.</span>",s+="<br/><br/>",s+="You can download the Data Proof for this game at:<br/>",s+='<span class="small"><a href="https://s3.amazonaws.com/notaryproxy-audit/'+e+'" target="_new">https://s3.amazonaws.com/notaryproxy-audit/'+e+"</a></span><br/>"),alertify.alert("Crypto Dice - Game Information",s)})}function addNewBet(e){refreshPlayerBets()}function refreshPlayerBets(){0==refreshingBets&&(refreshingBets=!0,requestBets()),setTimeout(function(){refreshPlayerBets()},refreshPlayerGames)}function refreshAllGames(){web3.eth.getCoinbase((e,t)=>{if(!e){t;let e=document.getElementById("latestGamesTable").getElementsByTagName("tbody")[0];cryptodiceContract.getPastEvents("DiceRollResult",{fromBlock:lastBlockAllGames+1,toBlock:"latest"},function(t,r){if(r.length>0)for(let t=0;t<r.length;t++){updateLastBlockAllGames(r[0].blockNumber);let l=r[t].returnValues,o=!1,n=0,s=!1;for(let e=0;e<latestGames.length;e++)if(l.betID==latestGames[e].betID){o=!0,2==latestGames[e].win&&(s=!0),n=e;break}if(0==o){latestGames.push(l);let t=e.insertRow(0),r=processBetRow(l,"_allGames",!1);1==l.win?t.className="betDisplay small orangeBackground_trans":t.className="betDisplay small",t.onclick=function(){showBet(l.betID)},t.innerHTML=r,t.id=l.betID+"_allGames_row";let a=e.getElementsByTagName("tr").length;a>maxRows&&e.deleteRow(a-1)}else if(s&&l.timestamp>latestGames[n].timestamp){var a=document.getElementById(l.betID+"_allGames_row");a&&a.parentNode.removeChild(a);let t=e.insertRow(0),r=processBetRow(l,"_allGames",!1);1==l.win?t.className="betDisplay small orangeBackground_trans":t.className="betDisplay small",t.onclick=function(){showBet(l.betID)},t.innerHTML=r,t.id=l.betID+"_allGames_row";let o=e.getElementsByTagName("tr").length;o>maxRows&&e.deleteRow(o-1),latestGames[n]=l}}})}}),setTimeout(function(){refreshAllGames()},refreshAllGames)}function requestBets(){web3.eth.getCoinbase((e,t)=>{var r="";if(e)refreshingBets=!1;else{r=t;let e=document.getElementById("previousGamesTable").getElementsByTagName("tbody")[0];cryptodiceContract.getPastEvents("DiceRollResult",{filter:{playerAddress:r},fromBlock:lastBlock+1,toBlock:"latest"},function(t,r){if(r.length>0){for(let t=0;t<r.length;t++){updateLastBlock(r[0].blockNumber);let l=r[t].returnValues,o=!1,n=0,s=!1;for(let e=0;e<playerLatestBets.length;e++)if(l.betID==playerLatestBets[e].betID){o=!0,2==playerLatestBets[e].win&&(s=!0),n=e;break}if(0==o){playerLatestBets.push(l);let t=e.insertRow(0),r=processBetRow(l,"",!0);1==l.win?t.className="betDisplay small orangeBackground_trans":t.className="betDisplay small",t.onclick=function(){showBet(l.betID)},t.innerHTML=r,t.id=l.betID+"_row";let a=e.getElementsByTagName("tr").length;a>maxRows&&e.deleteRow(a-1)}else if(s&&l.timestamp>playerLatestBets[n].timestamp){var a=document.getElementById(l.betID+"_row");a&&a.parentNode.removeChild(a);let t=e.insertRow(0),r=processBetRow(l,"",!0);1==l.win?t.className="betDisplay small orangeBackground_trans":t.className="betDisplay small",t.onclick=function(){showBet(l.betID)},t.innerHTML=r,t.id=l.betID+"_row";let o=e.getElementsByTagName("tr").length;o>maxRows&&e.deleteRow(o-1),playerLatestBets[n]=l}}refreshingBets=!1}else refreshingBets=!1})}})}window.addEventListener("load",function(){"undefined"!=typeof web3?(window.web3=new Web3(web3.currentProvider),startApp()):showNotConnectedMsg(),isMainGame&&selectRollUnder(document.getElementById("rollUnder40"))});let playerLatestBets=[],latestGames=[];function updateLastBlock(e){let t=new BigNumber(e),r=new BigNumber(lastBlock);t.isGreaterThan(r)&&(lastBlock=e)}function updateLastBlockAllGames(e){let t=new BigNumber(e),r=new BigNumber(lastBlockAllGames);t.isGreaterThan(r)&&(lastBlockAllGames=e)}function getLatestGames(){web3.eth.getCoinbase((e,t)=>{e||(t,cryptodiceContract.getPastEvents("DiceRollResult",{fromBlock:lastBlockAllGames,toBlock:"latest"},function(e,t){if(t.length>0){for(let e=t.length-1;e>-1;e--){t[e].transactionHash;let r=t[e].returnValues,a=!1;for(let e=0;e<latestGames.length;e++)if(r.betID==latestGames[e].betID){a=!0;break}0==a&&(latestGames.push(r),updateLastBlockAllGames(t[0].blockNumber))}for(var r=document.getElementById("latestGamesTable").getElementsByTagName("tbody")[0];r.rows.length>0;)r.deleteRow(0);var a=[];let e=0;e=0;let l=0;for(let t=0;t<latestGames.length&&!(++e>maxRows);t++){a[t]=r.insertRow(),l=t;let e=processBetRow(latestGames[t],"_allGames",!1);1==latestGames[t].win?a[t].className="betDisplay small orangeBackground_trans":a[t].className="betDisplay small",a[t].onclick=function(){showBet(latestGames[t].betID)},a[t].innerHTML=e,a[t].id=latestGames[t].betID+"_allGames_row"}}}))}),setTimeout(function(){refreshAllGames()},initAllGamesUpdate)}function getAllPlayerBets(){web3.eth.getCoinbase((e,t)=>{var r="";e||(r=t,cryptodiceContract.getPastEvents("DiceRollResult",{filter:{playerAddress:r},fromBlock:0,toBlock:"latest"},function(e,t){if(t.length>0){for(let e=t.length-1;e>-1;e--){t[e].transactionHash;let r=t[e].returnValues,a=!1;for(let e=0;e<playerLatestBets.length;e++)if(r.betID==playerLatestBets[e].betID){a=!0;break}0==a&&(playerLatestBets.push(r),updateLastBlock(t[0].blockNumber))}for(var r=document.getElementById("previousGamesTable").getElementsByTagName("tbody")[0];r.rows.length>0;)r.deleteRow(0);var a=[];let e=0;e=0;let l=0;for(let t=0;t<playerLatestBets.length&&!(++e>maxRows);t++){a[t]=r.insertRow(),l=t;let e=processBetRow(playerLatestBets[t],"",!0);1==playerLatestBets[t].win?a[t].className="betDisplay small orangeBackground_trans":a[t].className="betDisplay small",a[t].onclick=function(){showBet(playerLatestBets[t].betID)},a[t].innerHTML=e,a[t].id=playerLatestBets[t].betID+"_row"}let o=0;for(let e=l+1;e<playerLatestBets.length;e++)o++,1==playerLatestBets[e].win?(wins++,updateInnerHTML("wins",wins)):0==playerLatestBets[e].win&&playerLatestBets[e].result>0&&(losses++,updateInnerHTML("losses",losses))}}))}),setTimeout(function(){refreshPlayerBets()},initPlayerBetsUpdate)}function processBetRow(e,t,r){let a='<tr class="small betDisplay" id="'+e.betID+t+'_row">';if(a+="<td>"+formatTS(e.timestamp)+"</td>",0==isMainGame&&(a+="<td>"+e.playerAddress+"</td>"),a+="<td>"+e.rollUnder+"</td>",2==e.win?a+='<td id="'+e.betID+t+'_result"><img src="images/ani-dice.gif" width="16" height="16" border="0" alt="Waiting result of dice roll"/></td>':e.result>0?a+='<td id="'+e.betID+t+'_result">'+e.result+"</td>":a+='<td id="'+e.betID+t+'_result">FAIL</td>',a+="<td>"+web3.utils.fromWei(e.stake,"ether")+"</td>",1==e.win){1==r&&(wins++,updateInnerHTML("wins",wins)),a+='<td class="redColor" style="font-weight: bolder;">WIN!</td>';var l=new BigNumber(e.profit),o=new BigNumber(e.stake);a+="<td>+"+web3.utils.fromWei(l.plus(o).toString(10),"ether")+"</td></tr>"}else if(2==e.win)a+='<td id="'+e.betID+t+'_win">Pending</td>',a+='<td id="'+e.betID+t+'_profit">--</td>';else if(e.result>0){1==r&&(losses++,updateInnerHTML("losses",losses));o=new BigNumber(e.stake);a+="<td>LOSE</td>",a+="<td>-"+web3.utils.fromWei(o.toString(10),"ether")+"</td></tr>"}else a+="<td>--</td>",a+="<td>Refunded</td></tr>";return a}function updateInnerHTML(e,t){document.getElementById(e).innerHTML=t}function setStakeMinBet(){var e=document.getElementById("minBet");document.getElementById("stake").value=e.value,updatePotentialProfit()}function setStakeMaxBet(){var e=document.getElementById("maxBet");document.getElementById("stake").value=e.value,updatePotentialProfit()}function formatTS(e){var t=new Date(1e3*e),r=new Date(Date.now()),a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],l=t.getFullYear(),o=a[t.getMonth()],n=t.getDate(),s=t.getHours(),i=t.getMinutes(),d=t.getSeconds();if(l==r.getFullYear()&&o==a[r.getMonth()]&&n==r.getDate())var c=s+":"+i+":"+d;else c=n+" "+o+" "+l;return c}function formatTSLong(e){var t=new Date(1e3*e),r=(new Date(Date.now()),t.getFullYear()),a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()];return t.getDate()+" "+a+" "+r+" "+t.getHours()+":"+t.getMinutes()+":"+t.getSeconds()}